# Architecture: HTML Screenshot Generation Tool

## Status

Proposed

## Context

Feature spec: [specification.md](specification.md)

Feature 028 introduces a standalone .NET tool that generates screenshots (PNG/JPEG; WebP deferred) from HTML reports, primarily those produced by feature 027’s HTML renderer.

Key constraints from the spec:

- Separate **tool project** under `tools/` (not integrated into the main `tfplan2md` CLI).
- **Cross-platform** (Windows, Linux, macOS) and CI-friendly.
- Use **Chromium automation** via **Playwright for .NET**.
- CLI supports:
  - required input HTML path
  - optional output path (derived by default)
  - viewport width/height (defaults 1920x1080)
  - `--full-page` flag
  - format detection + explicit `--format`
  - lossy quality settings
- Error messages should be actionable; exit code `1` on failures.

This tool is intended for development/CI workflows:

- visual regression testing pipelines
- documentation screenshot generation
- validating GitHub/Azure DevOps “flavors” of rendered HTML

## Assumptions

- Input HTML is primarily generated by feature 027 (or otherwise “static enough”).
- Screenshot generation runs **headless only**.
- Network access may be present in CI for wrapper templates that reference CDN assets, but screenshots should still be usable if CDN assets fail to load (worst case: missing syntax highlighting).

## Options Considered

### Option 1: Playwright for .NET (Chromium) ✅ Recommended

- Use `Microsoft.Playwright` to launch bundled Chromium and take screenshots.
- Rely on Playwright’s standard browser installation workflow (`playwright install chromium`).

**Pros**
- Strong cross-platform story and first-class screenshot API.
- Full-page capture is a supported, stable capability.
- Widely used in CI; good diagnostics.

**Cons**
- Requires managing browser install step in CI (expected with Playwright).
- Tests that involve a real browser can be slower/flakier than pure unit tests.

### Option 2: Puppeteer Sharp

**Pros**
- Similar API and capabilities.

**Cons**
- Less aligned with the spec’s stated decision.
- Browser management and long-term maintenance risk compared to Playwright.

### Option 3: Selenium WebDriver + ChromeDriver

**Pros**
- Familiar in many orgs.

**Cons**
- Heavyweight, more moving parts (ChromeDriver compatibility).
- Poor fit for a small, deterministic, dev-tool style utility.

## Decision

Choose **Option 1: Playwright for .NET (Chromium)**.

This matches the feature spec’s “Technology Selection” decision, provides the simplest cross-platform operational story, and keeps the tool focused on screenshot generation rather than browser driver management.

## High-Level Design

### Project layout

Introduce a new console project:

- `tools/Oocx.TfPlan2Md.ScreenshotGenerator/`
- `tests/Oocx.TfPlan2Md.ScreenshotGenerator.Tests/`

This mirrors feature 027’s approach: the tool is separate from the main CLI project (consistent with [docs/spec.md](../../spec.md)).

### CLI and orchestration pattern

Follow the existing tooling style seen in feature 027’s HtmlRenderer:

- `Program` calls `ScreenshotGeneratorApp.RunAsync(args)` and returns an exit code.
- A minimal hand-rolled CLI parser (`CliParser`) produces a `CliOptions` record/class.
- `ScreenshotGeneratorApp` owns:
  - argument validation
  - file IO
  - output path derivation
  - error handling and user-facing messages
  - calling the screenshot engine

This keeps the tool dependency-light and consistent across `tools/*` projects.

### Suggested components (conceptual)

- `CLI/`
  - `CliOptions`
  - `CliParser`
  - `HelpTextProvider`
  - `CliParseException`
- `ScreenshotGeneratorApp`
  - validates inputs
  - resolves format + output path
  - ensures output directory exists
  - orchestrates screenshot capture
- `Capturing/`
  - `HtmlScreenshotCapturer`
    - `CaptureAsync(inputHtmlPath, outputImagePath, settings)`
  - `BrowserFactory` (optional)
    - encapsulates Playwright/Chromium launch configuration

This layering is mainly to keep browser concerns isolated and to allow most behaviors (path derivation, format parsing, validation) to be tested without invoking Playwright.

### Page loading model

To capture HTML output reliably, use a file-based navigation model:

- Convert input HTML path to a `file://` URL.
- Navigate via Playwright `page.GotoAsync(fileUrl, …)`.

Rationale:
- Preserves relative references in the HTML (e.g., `./style.css` in wrapper templates).
- Avoids having to inline assets.

Wait strategy (recommendation):
- Prefer waiting for the page `load` event with a bounded timeout.
- Avoid complex “dynamic content” waiting logic (explicitly out of scope).

### Screenshot modes

- **Viewport mode (default):**
  - Use viewport `(width,height)`.
  - Screenshot with `fullPage = false`.
- **Full-page mode (`--full-page`):**
  - Use viewport width; ignore `--height`.
  - Screenshot with `fullPage = true`.

### Image formats and quality

- Determine format in priority order:
  1. `--format`
  2. output extension
  3. default `png`
- Quality applies only to JPEG:
  - default `90`

Background handling:
- Ensure screenshots are captured with background included (do not request transparent backgrounds), matching the spec’s “no transparent background” constraint.

## Error Handling

Mirror the HtmlRenderer tool’s pattern: short, actionable `Error: ...` messages to stderr and exit code `1`.

Key categories:

- Input file missing/empty
- Invalid width/height/quality values
- Invalid format
- Output path unwritable
- Browser not installed / launch fails

Browser installation guidance:

- If Playwright reports missing browser binaries, print the recommended command:
  - `playwright install chromium` (and for Linux CI: `--with-deps`)

## Testing Strategy

Because browser-driven screenshots are inherently integration-like, split tests into two groups:

1. **Pure unit tests (fast, deterministic)**
   - CLI parsing (`--input`, `--output`, `--width`, `--height`, `--full-page`, `--format`, `--quality`)
   - output derivation rules (`.html` -> `.png`)
   - format detection and precedence (`--format` overrides extension)
   - validation rules and error messages

2. **Browser-backed tests (slower, conditional)**
   - Minimal HTML fixture renders to a screenshot file.
   - Validate the file exists, is non-empty, and (optionally) basic format signature checks.

Recommendation:
- Make browser-backed tests **skippable** when Chromium is not installed (the repo already uses skippable tests via `Xunit.SkippableFact`).
- In CI, explicitly install Chromium before running tests.

## CI/CD Notes

In GitHub Actions on Linux, Chromium dependencies are often required.

Recommended setup (as per the spec):

- Install the Playwright CLI tool and browsers:
  - `dotnet tool install --global Microsoft.Playwright.CLI`
  - `playwright install chromium --with-deps`

This keeps the screenshot generator tool itself small while still enabling reliable headless execution in CI.

## Risks and Mitigations

- **Risk: Test flakiness due to browser availability or OS deps**
  - Mitigation: skippable integration tests locally; CI installs browsers explicitly.

- **Risk: Full-page screenshots can be extremely tall and large**
  - Mitigation: keep default to viewport mode; require explicit `--full-page`.

- **Risk: External resources (CDN CSS/JS) affect screenshot determinism**
  - Mitigation: for regression tests, prefer wrapper templates that inline critical CSS or store local assets; treat CDN as “best effort”.

- **Risk: HTML navigation differences across platforms**
  - Mitigation: prefer `file://` navigation and keep the HTML renderer’s wrapper templates simple and self-contained.
