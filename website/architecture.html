<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture - tfplan2md</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="index.html" class="brand-link">
                    <img src="assets/images/logo-full.svg" alt="tfplan2md" height="64" class="brand-logo-full">
                </a>
            </div>
                        <div class="nav-menu">
                <a href="features/index.html" class="nav-item">Features</a>
                <a href="getting-started.html" class="nav-item">Install</a>
                <a href="docs.html" class="nav-item">Docs</a>
                <a href="examples.html" class="nav-item">Examples</a>
                <a href="providers/index.html" class="nav-item">Providers</a>
                <a href="architecture.html" class="nav-item active">Architecture</a>
                <a href="ai-workflow.html" class="nav-item">AI Workflow</a>
                <a href="contributing.html" class="nav-item">Contributing</a>
                <button class="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
                    <img src="assets/icons/dark-light-mode.svg" alt="Toggle theme" class="theme-icon">
                </button>
                <a href="https://github.com/oocx/tfplan2md" class="nav-item nav-cta">GitHub</a>
            </div>
        </div>
    </nav>

    <header class="hero" style="padding: 60px 0;">
        <div class="hero-container">
            <div class="hero-content">
                <h1 class="hero-title" style="font-size: 48px;">Architecture</h1>
                <p class="hero-subtitle">
                    Technical architecture based on arc42 documentation standard. Clean separation, extensible design, security-first.
                </p>
            </div>
        </div>
    </header>

    <!-- System Overview -->
    <section class="section" style="padding-top: 0;">
        <div class="section-container">
            <h2 class="section-title">System Overview</h2>
            <p class="section-description">
                tfplan2md converts Terraform plan JSON into Markdown reports optimized for pull request reviews.
            </p>

            <div class="arch-diagram">
                <div class="arch-flow">
                    <div class="arch-step">
                        <div class="arch-step-icon">üìÑ</div>
                        <h3 class="arch-step-title">Input</h3>
                        <p class="arch-step-desc">Terraform Plan JSON</p>
                        <code class="arch-step-cmd">terraform show -json</code>
                    </div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-step">
                        <div class="arch-step-icon">‚öôÔ∏è</div>
                        <h3 class="arch-step-title">tfplan2md</h3>
                        <p class="arch-step-desc">Parse ¬∑ Transform ¬∑ Render</p>
                    </div>
                    <div class="arch-arrow">‚Üí</div>
                    <div class="arch-step">
                        <div class="arch-step-icon">üìù</div>
                        <h3 class="arch-step-title">Output</h3>
                        <p class="arch-step-desc">Markdown Report</p>
                        <code class="arch-step-cmd">GitHub / Azure DevOps PR</code>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quality Goals -->
    <section class="section" style="background: var(--color-surface);">
        <div class="section-container">
            <h2 class="section-title">Quality Goals</h2>
            <div class="quality-grid">
                <div class="quality-card quality-1">
                    <div class="quality-priority">Priority 1</div>
                    <h3 class="quality-title">Security</h3>
                    <p class="quality-desc">Mask sensitive values by default ¬∑ FROM scratch container ¬∑ AOT-compiled static binary ¬∑ Non-root user (UID 1654) ¬∑ No shell ¬∑ Minimal attack surface</p>
                </div>
                <div class="quality-card quality-2">
                    <div class="quality-priority">Priority 2</div>
                    <h3 class="quality-title">Reliability</h3>
                    <p class="quality-desc">Handle malformed JSON gracefully ¬∑ Validate all markdown output ¬∑ Comprehensive test coverage</p>
                </div>
                <div class="quality-card quality-3">
                    <div class="quality-priority">Priority 3</div>
                    <h3 class="quality-title">Usability</h3>
                    <p class="quality-desc">Simple CLI ¬∑ Sensible defaults ¬∑ Clear error messages ¬∑ Zero configuration needed</p>
                </div>
                <div class="quality-card quality-4">
                    <div class="quality-priority">Priority 4</div>
                    <h3 class="quality-title">Maintainability</h3>
                    <p class="quality-desc">Clean architecture ¬∑ Immutable models ¬∑ Pure functions ¬∑ Modern C# patterns</p>
                </div>
                <div class="quality-card quality-5">
                    <div class="quality-priority">Priority 5</div>
                    <h3 class="quality-title">Extensibility</h3>
                    <p class="quality-desc">Custom templates ¬∑ Resource-specific renderers ¬∑ Provider-specific handling</p>
                </div>
                <div class="quality-card quality-6">
                    <div class="quality-priority">Priority 6</div>
                    <h3 class="quality-title">Performance</h3>
                    <p class="quality-desc">Fast startup for CI/CD ¬∑ Handle large plans efficiently ¬∑ 14.7MB Docker image (89.6% reduction) ¬∑ AOT compilation with aggressive trimming</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Architecture Components -->
    <section class="section">
        <div class="section-container">
            <h2 class="section-title">Core Components</h2>
            <p class="section-description">
                Clean separation of concerns with immutable data models and pure transformation functions.
            </p>

            <div class="component-grid">
                <div class="component-card">
                    <div class="component-icon">üéØ</div>
                    <h3 class="component-title">CLI</h3>
                    <p class="component-desc">Command-line parsing and orchestration. Handles user input, loads configuration, coordinates workflow.</p>
                    <div class="component-files">
                        <code>CliParser.cs</code>
                        <code>HelpTextProvider.cs</code>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-icon">üì¶</div>
                    <h3 class="component-title">Parsing</h3>
                    <p class="component-desc">Terraform plan JSON parsing into immutable domain models using System.Text.Json.</p>
                    <div class="component-files">
                        <code>TerraformPlan.cs</code>
                        <code>TerraformPlanParser.cs</code>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-icon">üîÑ</div>
                    <h3 class="component-title">Model Building</h3>
                    <p class="component-desc">Transform domain models into report models. Build resource summaries, group by module, apply inline diffing.</p>
                    <div class="component-files">
                        <code>ReportModel.cs</code>
                        <code>Summaries/*.cs</code>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-icon">‚úçÔ∏è</div>
                    <h3 class="component-title">Rendering</h3>
                    <p class="component-desc">Apply Scriban templates to generate markdown. Supports default templates, summary template, and custom user templates.</p>
                    <div class="component-files">
                        <code>MarkdownRenderer.cs</code>
                        <code>ScribanHelpers.cs</code>
                        <code>Templates/*.sbn</code>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-icon">‚òÅÔ∏è</div>
                    <h3 class="component-title">Azure Utilities</h3>
                    <p class="component-desc">Azure-specific functionality: principal ID mapping, resource ID parsing, role assignment formatting.</p>
                    <div class="component-files">
                        <code>PrincipalMapper.cs</code>
                        <code>azurerm/* templates</code>
                    </div>
                </div>

                <div class="component-card">
                    <div class="component-icon">üîí</div>
                    <h3 class="component-title">Security</h3>
                    <p class="component-desc">Sensitive value detection and masking. AOT-compiled static binary in FROM scratch container. Non-root user, no shell, minimal dependencies.</p>
                    <div class="component-files">
                        <code>--show-sensitive flag</code>
                        <code>FROM scratch + 3 musl libs</code>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Technology Stack -->
    <section class="section" style="background: var(--color-surface);">
        <div class="section-container">
            <h2 class="section-title">Technology Stack</h2>

            <div class="tech-table">
                <div class="tech-row">
                    <div class="tech-component">Compilation</div>
                    <div class="tech-name">NativeAOT (linux-musl-x64)</div>
                    <div class="tech-purpose">Ahead-of-time compilation to native executable with aggressive trimming</div>
                </div>
                <div class="tech-row">
                    <div class="tech-component">Language</div>
                    <div class="tech-name">C# 13</div>
                    <div class="tech-purpose">Modern language features: records, pattern matching, file-scoped namespaces</div>
                </div>
                <div class="tech-row">
                    <div class="tech-component">JSON Parser</div>
                    <div class="tech-name">System.Text.Json</div>
                    <div class="tech-purpose">Parse Terraform plan JSON with built-in .NET library</div>
                </div>
                <div class="tech-row">
                    <div class="tech-component">Template Engine</div>
                    <div class="tech-name">Scriban 6.5.2</div>
                    <div class="tech-purpose">Render markdown from customizable templates</div>
                </div>
                <div class="tech-row">
                    <div class="tech-component">Container Base</div>
                    <div class="tech-name">FROM scratch</div>
                    <div class="tech-purpose">Empty base with 3 musl libraries (14.7MB) - minimal attack surface, no shell, non-root user</div>
                </div>
                <div class="tech-row">
                    <div class="tech-component">Test Framework</div>
                    <div class="tech-name">TUnit 1.9.26</div>
                    <div class="tech-purpose">Unit and integration tests with comprehensive coverage, async-first design, and real-time progress reporting</div>
                </div>
                <div class="tech-row">
                    <div class="tech-component">Markdown Linter</div>
                    <div class="tech-name">markdownlint-cli2 0.20.0</div>
                    <div class="tech-purpose">Validate markdown output for GitHub/Azure DevOps compatibility</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Key Patterns -->
    <section class="section">
        <div class="section-container">
            <h2 class="section-title">Architectural Patterns</h2>

            <div class="pattern-grid">
                <div class="pattern-card">
                    <h3 class="pattern-title">Immutability</h3>
                    <p class="pattern-desc">All data models are immutable records. No mutable shared state. Pure functions for transformations.</p>
                    <div class="pattern-benefit">‚úÖ Thread-safe, predictable, easier to reason about</div>
                </div>

                <div class="pattern-card">
                    <h3 class="pattern-title">Template-Driven</h3>
                    <p class="pattern-desc">Default templates embedded as resources. Custom templates from filesystem. Resource-specific overrides.</p>
                    <div class="pattern-benefit">‚úÖ Flexible, customizable, user-controlled formatting</div>
                </div>

                <div class="pattern-card">
                    <h3 class="pattern-title">Separation of Concerns</h3>
                    <p class="pattern-desc">Clear boundaries: Parsing ‚Üí Model Building ‚Üí Rendering. Each component has single responsibility.</p>
                    <div class="pattern-benefit">‚úÖ Testable, maintainable, modular</div>
                </div>

                <div class="pattern-card">
                    <h3 class="pattern-title">Security by Default</h3>
                    <p class="pattern-desc">Sensitive values masked unless explicitly shown. FROM scratch containers with AOT-compiled static binaries. Non-root user, no shell, minimal dependencies.</p>
                    <div class="pattern-benefit">‚úÖ Safe for CI/CD, minimal attack surface, sub-second startup</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Architecture Decisions -->
    <section class="section" style="background: var(--color-surface);">
        <div class="section-container">
            <h2 class="section-title">Architecture Decision Records</h2>
            <p class="section-description">
                Key technical decisions and architectural patterns that shape tfplan2md. These guide consistent implementation across features.
            </p>

            <div class="arch-pattern-grid">
                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Scriban for Templating</h3>
                    <p class="arch-pattern-desc">
                        Lightweight, text-focused template engine with familiar syntax. Better fit than Razor or Liquid for markdown generation. 
                        Embeddable, supports custom functions, and works seamlessly with AOT compilation.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Decision:</strong> Use Scriban for all markdown generation. Enable user customization through filesystem templates. 
                        Provide composable partials for clean template organization.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">NativeAOT with FROM scratch</h3>
                    <p class="arch-pattern-desc">
                        Ahead-of-time compilation produces static native executable (linux-musl-x64). Deployed in FROM scratch container with only 3 musl libraries. 
                        Achieves 14.7MB image size (89.6% reduction from baseline) with fastest possible startup time.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> Minimal attack surface, no shell, non-root user (UID 1654), sub-second startup in CI/CD. 
                        Build-time resource embedding with custom ResourceManager avoids runtime reflection.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Modern C# 13 Patterns</h3>
                    <p class="arch-pattern-desc">
                        Records for immutable data models, file-scoped namespaces, nullable reference types, pattern matching. 
                        Comprehensive XML documentation (including private members) for AI-assisted development.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> Thread-safe, predictable, easier to reason about. Supports 100% AI-assisted development workflow 
                        with GitHub Copilot multi-model approach.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">CSS Layers for Website Examples</h3>
                    <p class="arch-pattern-desc">
                        CSS <code>@layer</code> directive isolates rendered example styles from website page styles. Examples use 
                        <code>@layer examples</code> with lower cascade priority than website styles.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> Prevents specificity conflicts. Examples remain readable while website styles always win conflicts. 
                        Clean separation between content and presentation layers.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Resource-Specific Templates with ViewModels</h3>
                    <p class="arch-pattern-desc">
                        Complex resources (firewall rules, NSG rules, role assignments, variable groups) use specialized templates with ViewModel pattern. 
                        C# Factory precomputes semantic diffs, matches items by key (e.g., rule name), formats before/after comparisons.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> Testable C# logic for complex merging/matching. Clean templates iterate preformatted rows. 
                        Powerful semantic diffing without Scriban limitations.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Single-Pass Template Rendering</h3>
                    <p class="arch-pattern-desc">
                        Direct template dispatch replaces render-then-replace pattern. Main template orchestrates with composable partials 
                        (<code>_header.sbn</code>, <code>_resource.sbn</code>, <code>_footer.sbn</code>). Resource-specific templates override default partial.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> No anchors or regex replacement. Explicit, debuggable template selection. 
                        No wasted computation. Scriban <code>include</code> with custom template loader.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Markdig for Platform-Specific HTML</h3>
                    <p class="arch-pattern-desc">
                        Standalone HtmlRenderer tool converts markdown to HTML with GitHub and Azure DevOps flavors. Uses Markdig 
                        with platform-specific pipelines. GitHub strips <code>style</code> attributes; Azure DevOps preserves for theme support.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Use Case:</strong> Visual testing, website examples, screenshot generation. Wrapper templates with <code>{{content}}</code> placeholder. 
                        Not pixel-perfect but "good enough approximation" for development workflows.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Playwright for Visual Regression</h3>
                    <p class="arch-pattern-desc">
                        ScreenshotGenerator tool uses Playwright + Chromium for automated screenshot capture. Supports full-page capture, 
                        element targeting by Terraform resource address or CSS selector, multiple formats (PNG/JPEG).
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>CI Integration:</strong> Cross-platform, headless-only, actionable error messages. 
                        Union bounding box for multiple element matches. Enables visual regression testing pipelines.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">DiagnosticContext for Debug Output</h3>
                    <p class="arch-pattern-desc">
                        Optional diagnostics collected throughout pipeline via DiagnosticContext passed to components. 
                        Single <code>--debug</code> flag appends section showing principal mapping status, template resolution, failed ID lookups.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> Non-intrusive (zero impact when disabled). Clean separation (diagnostics separate from business logic). 
                        Flexible (easy to add new categories). Matches immutable architecture patterns.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Report Metadata for Build Traceability</h3>
                    <p class="arch-pattern-desc">
                        Every report includes metadata line: tfplan2md version, git commit hash (7 chars), generation timestamp UTC, Terraform version. 
                        Format: <code>Generated by tfplan2md X.Y.Z (abc1234) on YYYY-MM-DD HH:MM:SS UTC | Terraform 1.x.x</code>
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> Audit trail for debugging. Mockable MetadataProvider for deterministic tests. 
                        Suppressible with <code>--hide-metadata</code> flag.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">TUnit for Async-First Testing</h3>
                    <p class="arch-pattern-desc">
                        Modern test framework with true async support, real-time progress reporting, parallel execution. 
                        Comprehensive test coverage (unit, integration, snapshot) with fast feedback loops.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Benefits:</strong> Faster than MSTest/xUnit. Native async/await support. Better diagnostics. 
                        Aligns with modern C# patterns and AI-assisted development workflow.
                    </div>
                </div>

                <div class="arch-pattern-card">
                    <h3 class="arch-pattern-title">Terraform Show Approximation</h3>
                    <p class="arch-pattern-desc">
                        Development script generates plan JSON from config + state without <code>terraform plan</code> execution. 
                        Constructs synthetic plan structure for rapid iteration on resource-specific templates.
                    </p>
                    <div class="arch-pattern-impl">
                        <strong>Use Case:</strong> Rapid development workflow. Test templates without full plan cycle. 
                        <strong>Note:</strong> Approximation only; not suitable for production use.
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Full Documentation Link -->
    <section class="section">
        <div class="section-container">
            <div class="cta-box">
                <h2 class="cta-title">Complete Architecture Documentation</h2>
                <p class="cta-description">
                    This page provides a high-level overview. For complete details including building block views, runtime scenarios, deployment architecture, and design decisions, see the full arc42 documentation.
                </p>
                <div class="cta-actions">
                    <a href="https://github.com/oocx/tfplan2md/blob/main/docs/architecture.md" class="btn btn-primary">View Full Architecture (arc42)</a>
                    <a href="https://github.com/oocx/tfplan2md/tree/main/docs" class="btn btn-secondary">Browse All Documentation</a>
                </div>
            </div>
        </div>
    </section>

    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4 class="footer-heading">Product</h4>
                    <a href="features/index.html" class="footer-link">Features</a>
                    <a href="getting-started.html" class="footer-link">Get Started</a>
                    <a href="docs.html" class="footer-link">Documentation</a>
                </div>
                <div class="footer-col">
                    <h4 class="footer-heading">Resources</h4>
                    <a href="https://github.com/oocx/tfplan2md" class="footer-link">GitHub</a>
                    <a href="https://hub.docker.com/r/oocx/tfplan2md" class="footer-link">Docker Hub</a>
                    <a href="examples.html" class="footer-link">Examples</a>
                    <a href="architecture.html" class="footer-link">Architecture</a>
                </div>
                <div class="footer-col">
                    <h4 class="footer-heading">Community</h4>
                    <a href="https://github.com/oocx/tfplan2md/issues" class="footer-link">Issues</a>
                    <a href="contributing.html" class="footer-link">Contributing</a>
                    <a href="https://github.com/oocx/tfplan2md/blob/main/LICENSE" class="footer-link">License</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="footer-copyright">¬© 2025 tfplan2md ‚Ä¢ MIT License</p>
                <p class="footer-note">Built 100% with GitHub Copilot</p>
            </div>
        </div>
    </footer>

    <script>
        const themeToggle = document.querySelector('.theme-toggle');
        const html = document.documentElement;
        
        const currentTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', currentTheme);
        updateThemeButton(currentTheme);
        
        themeToggle.addEventListener('click', () => {
            const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        });
        
        function updateThemeButton(theme) {
            const label = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
            themeToggle.setAttribute('aria-label', label);
            themeToggle.setAttribute('title', label);
        }
    </script>
</body>
</html>
