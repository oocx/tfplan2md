# Report Style Guide

This document defines the styling and formatting guidelines for all Markdown reports generated by `tfplan2md`. These guidelines ensure consistency, readability, and a professional appearance across all output formats (default, summary, and resource-specific templates).

## Core Philosophy

**"Data is Code, Labels are Text"**

The primary design principle is to visually distinguish **data values** (what is changing) from **labels and descriptions** (context).

- **Data Values**: Rendered as `inline code` (using backticks). This includes resource names, IDs, IP addresses, configuration settings, and any value extracted from the Terraform plan.
- **Labels & Keys**: Rendered as **plain text**. This includes attribute names, table headers, descriptive text, and action verbs.

## Text Formatting Rules

### 1. Attribute Tables

- **Attribute Names (Keys)**: Plain text.
- **Attribute Values**: Code-formatted.
- **Null/Empty Values**: Represented as `-` (plain text).

**Correct:**
```markdown
| Attribute | Value |
|-----------|-------|
| location | `eastus` |
| sku | `Standard` |
```

**Incorrect:**
```markdown
| `location` | eastus |  <-- Key should be plain, value should be code
| sku | Standard |       <-- Value should be code
```

### 2. Resource Summaries

Resource changes are displayed in collapsible `<details>` sections with rich summary lines for quick scanning.

#### Summary Format

```html
<details>
<summary>{action_icon} {resource_type} <b><code>{resource_name}</code></b> â€” {context_info}</summary>
<br>
{content}
</details>
```

#### Components

- **Action Icon**: Visual indicator (â•, ğŸ”„, â™»ï¸, âŒ)
- **Resource Type**: Plain text (e.g., `azurerm_virtual_network`)
- **Resource Name**: Bold + code-formatted (e.g., `<b><code>hub</code></b>`)
  - For resources in modules, only the **local name** is shown (e.g., `rg_reader` not `module.security.azurerm_role_assignment.rg_reader`)
- **Context Info**: Code-formatted values separated by plain text connectors
  - Resource identifiers (name, ID)
  - Key attributes (location, CIDR blocks)
  - Changed attribute summary for updates: `<count> ğŸ”§ <attributes>`

#### HTML Code Tags in Summaries

Azure DevOps does not reliably render markdown backticks inside HTML `<summary>` tags. Therefore:
- Use HTML `<code>` tags for code formatting in summary lines
- Use backticks for code formatting in tables (outside `<summary>`)

**Example Summaries:**

**Create:**
```html
<summary>â• azurerm_virtual_network <b><code>hub</code></b> â€” <code>vnet-hub</code> in <code>rg-demo</code> <code>ğŸŒ eastus</code> | <code>ğŸŒ 10.0.0.0/16</code></summary>
```

**Update:**
```html
<summary>ğŸ”„ azurerm_storage_account <b><code>data</code></b> â€” <code>stdata</code> | 2 ğŸ”§ account_replication_type, tags.cost_center</summary>
```

**Delete:**
```html
<summary>âŒ azurerm_resource_group <b><code>legacy</code></b> â€” <code>rg-old</code> <code>ğŸŒ westus</code></summary>
```

**Role Assignment (with icons):**
```html
<summary>â• azurerm_role_assignment <b><code>rg_reader</code></b> â€” <code>ğŸ‘¤ Jane Doe (User)</code> â†’ <code>ğŸ›¡ï¸ Reader</code> on <code>rg-demo</code></summary>
```

Note: The resource name shows only `rg_reader` (local name), not the full module path.

### 3. Tags Display

Tags are displayed as inline badges below the main attribute table for create and delete operations.

- **Header**: Bold with ğŸ·ï¸ icon (icon is **outside** code formatting)
- **Format**: `**ğŸ·ï¸ Tags:** `key: value` `key: value` `key: value``
- **Each tag**: Separate code-formatted backticks per key-value pair
- **Placement**: After the attribute table, before the closing `</details>` tag

**Example:**
```markdown
| Attribute | Value |
|-----------|-------|
| location | `ğŸŒ eastus` |
| name | `rg-demo` |

**ğŸ·ï¸ Tags:** `environment: production` `owner: devops` `cost_center: 1234`
```

**For Updates**: Tag changes appear in the Before/After attribute table, not as inline badges.

### 4. Large Value Headings

For large values moved to collapsible sections:

- **Level**: H5 (`#####`)
- **Style**: Bold label, plain text.
- **Suffix**: Colon (`:`).

**Format:** `##### **<attribute_name>:**`

**Example:**
```markdown
##### **custom_data:**
```

## Structure & Hierarchy

### Headings

- **H1 (`#`)**: Report Title (e.g., "Terraform Plan Report").
- **H2 (`##`)**: Major Sections (e.g., "Summary", "Resource Changes").
- **H3 (`###`)**: Module Grouping (e.g., "ğŸ“¦ Module: root", "ğŸ“¦ Module: `module.network`").
- **H4 (`####`)**: Not used (resources are in collapsible `<details>` sections).
- **H5 (`#####`)**: Large Value Attribute Names within collapsible sections.

### Resource Display Structure

Resources are displayed in collapsible `<details>` sections rather than traditional headings:

```html
<details>
<summary>{action_icon} {resource_type} <b><code>{name}</code></b> â€” {context}</summary>
<br>

{attribute_table}

{optional_tags}

{optional_large_values}

</details>
```

This structure:
- Provides collapsible content for cleaner reports
- Allows quick scanning via summary lines
- Maintains proper heading hierarchy (H3 for modules, no H4 for resources)

### Module Grouping

- Changes are grouped by module.
- Modules are separated by horizontal rules (`---`) for clear visual breaks.
- The root module is labeled as `root` (plain text).
- Module paths are code-formatted if they are not "root".
- Module headers use the ğŸ“¦ icon before the label.

**Root Module:**
```markdown
### ğŸ“¦ Module: root
```

**Named Module:**
```markdown
---

### ğŸ“¦ Module: `module.network`
```

**Nested Module:**
```markdown
---

### ğŸ“¦ Module: `module.network.module.monitoring`
```

## Tables

### Standard Columns

- **Create/Delete**: `Attribute` | `Value`
- **Update/Replace**: `Attribute` | `Before` | `After`

### Alignment

- Use default Markdown alignment (usually left-aligned).
- Do not force alignment with colons in the separator line unless necessary for numeric data.

## Diff Representation

### Small Values (In-Table)

For modified attributes that fit within a table cell:

- **Format**: Stacked lines separated by `<br>`.
- **Prefixes**: `- ` for the old value, `+ ` for the new value.
- **Styling**: Values are code-formatted.

**Example:**
```markdown
- `80`<br>+ `8080`
```

### Large Values (Collapsible)

For multi-line strings or long values (>100 chars):

- **Container**: `<details>` block.
- **Summary**: `<summary>Large values: <attribute_name> (<stats>)</summary>`
- **Content**:
    - **Inline Diff**: HTML `<pre>` block with styled `<span>` elements for character-level highlighting.
    - **Simple Diff**: Code block with `diff` language identifier.

## Icons & Symbols

### Action Icons

Use the following standard set of icons to indicate resource change actions:

| Action | Icon | Meaning | Usage |
|--------|------|---------|-------|
| Create | â• | Resource is being created | Appears before resource address in summaries |
| Update | ğŸ”„ | Resource is being modified in-place | Appears before resource address in summaries |
| Delete | âŒ | Resource is being destroyed | Appears before resource address in summaries |
| Replace| â™»ï¸ | Resource is being destroyed and recreated | Appears before resource address in summaries |
| No-Op  | âºï¸ | Resource is unchanged | Used in resource-specific rule change tables |

### Semantic Value Icons

Icons are applied to specific value types to enhance visual scanning and comprehension. Icons are placed **inside** code formatting (backticks or HTML `<code>` tags) alongside the value.

#### Network & Infrastructure

| Icon | Value Type | Pattern | Example | When to Use |
|------|------------|---------|---------|-------------|
| ğŸŒ | IP Address / CIDR | `ğŸŒ <address>` | `ğŸŒ 10.1.1.0/24` | Any value matching IP address or CIDR format (requires dot notation) |
| ğŸŒ | Location / Region | `ğŸŒ <region>` | `ğŸŒ eastus` | Azure regions, geographic locations |
| ğŸ”Œ | Port Number | `ğŸ”Œ <port>` | `ğŸ”Œ 443` | Network port numbers |

#### Protocols & Directions

| Icon | Value Type | Pattern | Example | When to Use |
|------|------------|---------|---------|-------------|
| ğŸ”— | TCP Protocol | `ğŸ”— TCP` | `ğŸ”— TCP` | TCP protocol values |
| ğŸ“¨ | UDP Protocol | `ğŸ“¨ UDP` | `ğŸ“¨ UDP` | UDP protocol values |
| ğŸ“¡ | ICMP Protocol | `ğŸ“¡ ICMP` | `ğŸ“¡ ICMP` | ICMP protocol values |
| âœ³ï¸ | Wildcard / Any | `âœ³ï¸` | `âœ³ï¸` | Asterisk wildcards (protocol/port "any") - icon only, no text |
| â¬‡ï¸ | Inbound | `â¬‡ï¸ Inbound` | `â¬‡ï¸ Inbound` | Inbound network traffic direction |
| â¬†ï¸ | Outbound | `â¬†ï¸ Outbound` | `â¬†ï¸ Outbound` | Outbound network traffic direction |

#### Security & Access

| Icon | Value Type | Pattern | Example | When to Use |
|------|------------|---------|---------|-------------|
| âœ… | Allow / True | `âœ… Allow` or `âœ… true` | `âœ… Allow` | Security rule "Allow" action or boolean true values |
| â›” | Deny | `â›” Deny` | `â›” Deny` | Security rule "Deny" action |
| âŒ | False | `âŒ false` | `âŒ false` | Boolean false values |

#### Identity & Roles

| Icon | Value Type | Pattern | Example | When to Use |
|------|------------|---------|---------|-------------|
| ğŸ‘¤ | User | `ğŸ‘¤ User` | `ğŸ‘¤ Jane Doe (User)` | Azure AD user principals |
| ğŸ‘¥ | Group | `ğŸ‘¥ Group` | `ğŸ‘¥ DevOps Team (Group)` | Azure AD group principals |
| ğŸ’» | Service Principal | `ğŸ’» ServicePrincipal` | `ğŸ’» App (ServicePrincipal)` | Azure AD service principals |
| ğŸ›¡ï¸ | Role | `ğŸ›¡ï¸ <role_name>` | `ğŸ›¡ï¸ Reader` | Azure role definitions |

#### Other Markers

| Icon | Purpose | Pattern | Example | When to Use |
|------|---------|---------|---------|-------------|
| ğŸ·ï¸ | Tags | `**ğŸ·ï¸ Tags:**` | `**ğŸ·ï¸ Tags:** `env: prod`` | Tags section header (icon outside code) |
| ğŸ”§ | Changed Attributes | `<count> ğŸ”§ <attrs>` | `2 ğŸ”§ name, location` | Update summaries showing changed attribute count |
| ğŸ“¦ | Module | `### ğŸ“¦ Module:` | `### ğŸ“¦ Module: network` | Module section headers |

### Icon Placement Rules

**Inside Code Formatting** (data values):
- Network values: `ğŸŒ 10.0.0.0/16`, `ğŸ”Œ 443`, `ğŸŒ eastus`
- Protocols: `ğŸ”— TCP`, `ğŸ“¨ UDP`, `ğŸ“¡ ICMP`
- Access/Booleans: `âœ… Allow`, `â›” Deny`, `âœ… true`, `âŒ false`
- Directions: `â¬‡ï¸ Inbound`, `â¬†ï¸ Outbound`
- Principals: `ğŸ‘¤ User`, `ğŸ‘¥ Group`, `ğŸ’» ServicePrincipal`
- Roles: `ğŸ›¡ï¸ Reader`

**Outside Code Formatting** (labels):
- Tags header: `**ğŸ·ï¸ Tags:**`
- Module headers: `### ğŸ“¦ Module:`

**Example in table:**
```markdown
| Attribute | Value |
|-----------|-------|
| protocol | `ğŸ”— TCP` |
| source_address_prefix | `ğŸŒ 10.1.0.0/16` |
| destination_port_range | `ğŸ”Œ 443` |
| access | `âœ… Allow` |
| direction | `â¬‡ï¸ Inbound` |
```

**Example in summary:**
```markdown
<summary>â• azurerm_network_security_rule <b><code>allow_https</code></b> â€” <code>AllowHTTPS</code> | <code>âœ… Allow</code> | <code>â¬‡ï¸ Inbound</code> | <code>ğŸ”— TCP</code> | Priority 100</summary>
```

### Inline Diff Icons

When values with semantic icons appear in inline HTML diffs (changed values), the icons are preserved through custom HTML encoding:

**Example:**
- Protocol change: `- ğŸ“¨ UDP` â†’ `+ ğŸ”— TCP`
- IP list addition: `- ğŸŒ 10.1.1.0/24` â†’ `+ ğŸŒ 10.1.1.0/24, ğŸŒ 10.1.2.0/24`
- Port addition: `- ğŸ”Œ 8443` â†’ `+ ğŸ”Œ 8443, ğŸ”Œ 9443`

The custom HTML encoding ensures emoji characters render correctly in both GitHub and Azure DevOps while still escaping HTML special characters.

## Resource-Specific Templates

Custom templates (e.g., Firewall, NSG, Role Assignments) must adhere to these guidelines:

1. **Structure**: Use the same collapsible `<details>` structure with HTML comment anchors:
   ```html
   <!-- tfplan2md:resource-start address={address} -->
   <details>
   <summary>{summary_content}</summary>
   <br>
   {content}
   </details>
   <!-- tfplan2md:resource-end address={address} -->
   ```

2. **Headers**: Use code formatting for dynamic values (e.g., `**Collection:** `public-egress``).

3. **Rule Tables**: All data cells (names, IPs, ports, protocols) must be code-formatted with appropriate semantic icons:
   - IPs: `ğŸŒ 10.1.1.0/24`
   - Ports: `ğŸ”Œ 443`
   - Protocols: `ğŸ”— TCP`, `ğŸ“¨ UDP`, `ğŸ“¡ ICMP`
   - Access: `âœ… Allow`, `â›” Deny`
   - Direction: `â¬‡ï¸ Inbound`, `â¬†ï¸ Outbound`

4. **Diffs**: Use inline HTML diffs with semantic icons preserved via `format_attribute_value_plain` helper.

5. **Local Resource Names**: For resources in modules, display only the local name in summaries (e.g., `rg_reader` not `module.security.azurerm_role_assignment.rg_reader`).

**Example (Firewall Rule with icons):**
```markdown
| Change | Rule Name | Protocols | Source Addresses | Destination Addresses | Destination Ports | Description |
| -------- | ----------- | ----------- | ------------------ | ---------------------- | ------------------- | ------------- |
| â• | `allow-web-secure` | `ğŸ”— TCP` | `ğŸŒ 10.1.1.0/24` | `ğŸŒ 10.1.3.0/24` | `ğŸ”Œ 443` | `Secure web` |
| ğŸ”„ | `allow-dns` | `ğŸ“¨ UDP` | {inline_diff} | `ğŸŒ 168.63.129.16` | `ğŸ”Œ 53` | `DNS to Azure` |
```

**Example (Role Assignment summary with icons and local name):**
```html
<summary>â• azurerm_role_assignment <b><code>rg_reader</code></b> â€” <code>ğŸ‘¤ Jane Doe (User)</code> â†’ <code>ğŸ›¡ï¸ Reader</code> on <code>rg-demo</code></summary>
```
