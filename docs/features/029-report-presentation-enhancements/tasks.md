# Tasks: Report Presentation Enhancements

## Overview

This feature implements visual and tooling improvements to enhance report presentation, including resource border styling, report metadata, partial screenshot capture, and semantic icons for naming attributes.

Reference: [specification.md](specification.md), [architecture.md](architecture.md)

## Tasks

### Task 1: Implement Deterministic Metadata Provider

**Priority:** High

**Description:**
Create a mechanism to provide tfplan2md version, commit hash, and generation timestamp to the report model. Ensure it can be mocked/overridden for deterministic snapshot tests.

**Acceptance Criteria:**
- [x] `ReportModel` includes fields for `TfPlan2MdVersion`, `CommitHash`, `GeneratedAtUtc`, and `HideMetadata`.
- [x] Metadata is sourced from assembly attributes (version, commit).
- [x] A `IMetadataProvider` (or similar) interface is introduced to allow injecting fixed values during tests.
- [x] Default implementation uses real assembly data and `DateTimeOffset.UtcNow`.

**Dependencies:** None

---

### Task 2: Report Metadata Display and CLI Option

**Priority:** High

**Description:**
Update the CLI to support `--hide-metadata` and update the report templates to display the metadata line in the header.

**Acceptance Criteria:**
- [x] `tfplan2md` CLI accepts `--hide-metadata` flag.
- [x] Report header displays: `Generated by tfplan2md <version> (<commit>) on <timestamp> UTC | Terraform <tf_version>`.
- [x] Metadata and Terraform version appear on the same line.
- [x] If `--hide-metadata` is true, the entire line is omitted.
- [x] Templates (`_header.sbn` or equivalent) are updated to use the new model fields.

**Dependencies:** Task 1

---

### Task 3: Stabilize Snapshot Tests

**Priority:** High

**Description:**
Update existing snapshot tests to use the deterministic metadata provider so that snapshots remain stable across runs.

**Acceptance Criteria:**
- [x] All snapshot tests use fixed values for version, commit, and timestamp.
- [x] Existing snapshots are updated once to include the new metadata line (with fixed values).
- [x] Subsequent test runs do not produce diffs due to timestamp/version changes.

**Dependencies:** Task 2

---

### Task 4: Semantic Icons for Naming Attributes

**Priority:** Medium

**Description:**
Update semantic formatting helpers to add icons for `name` and `resource_group_name` attributes.

**Acceptance Criteria:**
- [ ] `resource_group_name` attribute displays with üìÅ icon.
- [ ] `name` attribute (all providers) displays with üÜî icon.
- [ ] Icons use non-breaking space (`&nbsp;`) between icon and value.
- [ ] Formatting is consistent in both table cells and `<summary>` blocks.
- [ ] `ScribanHelpers.FormatAttributeValue*` (or equivalent) are updated.

**Dependencies:** None

---

### Task 5: Update Resource Summary Icons

**Priority:** Medium

**Description:**
Ensure that the resource summary line (the `<summary>` tag) also uses the new semantic icons for consistency.

**Acceptance Criteria:**
- [ ] `ResourceChangeModel.SummaryHtml` (or equivalent) uses the semantic formatting helpers for `name` and `resource_group_name`.
- [ ] Icons appear in the expandable resource header in the report.

**Dependencies:** Task 4

---

### Task 6: Resource Border Styling and Details Wrappers

**Priority:** High

**Description:**
Apply consistent border styling to all resource blocks in the Markdown output.

**Acceptance Criteria:**
- [ ] Default resource template (`_resource.sbn`) uses `<details style="margin-bottom:12px; border:1px solid #f0f0f0; padding:12px;">`.
- [ ] Resource-specific templates that don't use `<details>` (e.g., Firewall, NSG) are wrapped in `<details open style="...">`.
- [ ] Nested `<details>` blocks (for large attributes) do NOT get the border styling (only the outermost resource block).
- [ ] Added a stable way to identify resource blocks for the screenshot tool (e.g., a specific text pattern or structure as per architecture).

**Dependencies:** None

---

### Task 7: Verify HTML Renderer Style Handling

**Priority:** Medium

**Description:**
Ensure the `HtmlRendererApp` correctly handles the new inline styles for different platforms.

**Acceptance Criteria:**
- [ ] Azure DevOps flavor preserves/normalizes the `style` attribute on `<details>`.
- [ ] GitHub flavor strips the `style` attribute from `<details>`.
- [ ] Unit tests in `Oocx.TfPlan2Md.HtmlRenderer.Tests` verify this behavior.

**Dependencies:** Task 6

---

### Task 8: Screenshot Tool CLI Enhancements

**Priority:** Medium

**Description:**
Extend the `ScreenshotGenerator` tool with options to target specific elements.

**Acceptance Criteria:**
- [ ] `ScreenshotGenerator` accepts `--target-terraform-resource-id <address>`.
- [ ] `ScreenshotGenerator` accepts `--target-selector <selector>`.
- [ ] CLI parser correctly populates the options object.

**Dependencies:** None

---

### Task 9: Implement Partial Screenshot Capture

**Priority:** Medium

**Description:**
Implement the logic to capture only the targeted element(s) using Playwright.

**Acceptance Criteria:**
- [ ] If `--target-terraform-resource-id` is used, the tool locates the resource block by matching the module heading and summary text (as per architecture).
- [ ] If `--target-selector` is used, the tool uses the Playwright selector.
- [ ] If multiple elements match, the union bounding box is captured.
- [ ] The tool fails with a non-zero exit code and clear error message if no target is found.
- [ ] The output image is cropped to the target element(s).

**Dependencies:** Task 8, Task 6 (for stable targeting)

---

### Task 10: Documentation and UAT

**Priority:** Low

**Description:**
Update project documentation and verify the feature with UAT.

**Acceptance Criteria:**
- [ ] `README.md` or other relevant docs updated with new CLI options (`--hide-metadata`, screenshot targets).
- [ ] UAT artifacts generated and verified in GitHub and Azure DevOps.
- [ ] All UAT scenarios from `uat-test-plan.md` pass.

**Dependencies:** All previous tasks

## Implementation Order

1. **Task 1, 2, 3**: Foundation for metadata and snapshot stability. This is critical to avoid breaking existing tests.
2. **Task 4, 5**: Semantic icons. Relatively independent and improves visual clarity.
3. **Task 6, 7**: Resource borders. Core visual change.
4. **Task 8, 9**: Screenshot tool enhancements. Depends on Task 6 for reliable targeting.
5. **Task 10**: Final verification and documentation.

## Open Questions

None.
