# Feature: HTML Screenshot Generation Tool

## Overview

A standalone .NET tool that generates screenshots from HTML files using the Chromium browser engine. This tool enables visual regression testing, documentation screenshot generation, and automated testing workflows by converting HTML reports (generated by feature 027's HTML renderer) into image files.

## User Goals

- **QA engineers** want to generate screenshots of tfplan2md reports for visual regression testing
- **Documentation maintainers** want to create screenshot examples for project documentation and websites
- **CI/CD pipelines** want to automatically generate screenshot artifacts during automated testing
- **Development teams** want to visually validate report rendering across different platforms (GitHub/Azure DevOps flavors)

## Scope

### In Scope

**Core Functionality:**
- Standalone .NET 10 console application as a separate project in the solution
- Chromium-based screenshot generation using Playwright for .NET
- Command-line interface with options for:
  - Input HTML file path (required)
  - Output image file path (optional, derived from input if not provided)
  - Viewport width (optional, default: 1920)
  - Viewport height (optional, default: 1080)
  - Full-page capture mode (optional flag)
  - Image format selection (optional, derived from output filename or explicit format parameter)
  - Image quality for lossy formats (optional, sensible defaults)

**Screenshot Capabilities:**
- Fixed viewport size screenshots (default: 1920x1080)
- Customizable viewport dimensions via CLI arguments
- Full-page capture mode (captures entire scrollable content, variable height)
- Multiple output formats: PNG, JPEG (WebP deferred per maintainer request)
- Format detection from output filename extension
- Quality setting for JPEG with a sensible default

**Platform Support:**
- Local development machines (Windows, Linux, macOS)
- GitHub Actions CI/CD pipelines
- Automatic Chromium installation via Playwright

**Testing:**
- Unit test project for the screenshot generator
- Tests covering different viewport sizes
- Tests for full-page capture mode
- Tests for multiple output formats
- Validation that screenshots are generated correctly

### Out of Scope

- **Direct markdown input** (tool accepts HTML only; users should use feature 027's HTML renderer first)
- **Batch processing** of multiple files in one command (run tool multiple times or use shell scripts)
- **Screenshot comparison or diff generation** (visual regression testing frameworks handle this separately)
- **Custom CSS injection** beyond what's in the input HTML (users should customize HTML renderer templates)
- **JavaScript execution delays** or waiting for dynamic content (assumes static HTML)
- **PDF output** (use browser print-to-PDF if needed; separate concern)
- **Transparent backgrounds** for PNG (uses white/default background)
- **Screenshot annotations** or overlays (post-processing concern)
- **Integration into tfplan2md CLI** (this is a separate development tool)
- **Headless/headful mode selection** (always runs headless for automation)

## User Experience

### Command-Line Interface

**Basic Usage - Default Viewport:**
```bash
dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
  --input artifacts/comprehensive-demo.github.html
```
Output: `artifacts/comprehensive-demo.github.png` (1920x1080, PNG format)

**Custom Viewport Size:**
```bash
dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
  --input artifacts/comprehensive-demo.github.html \
  --output artifacts/screenshot-1280x720.png \
  --width 1280 \
  --height 720
```
Output: `artifacts/screenshot-1280x720.png` (1280x720, PNG format)

**Full-Page Capture:**
```bash
dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
  --input artifacts/comprehensive-demo.azdo.html \
  --output artifacts/full-report.png \
  --full-page
```
Output: `artifacts/full-report.png` (1920x[variable], full scrollable height)

**Different Image Formats:**
```bash
# JPEG output (format detected from extension)
dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
  --input artifacts/comprehensive-demo.github.html \
  --output artifacts/screenshot.jpg

# Explicit format parameter (overrides extension)
dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
  --input artifacts/comprehensive-demo.github.html \
  --output artifacts/screenshot.img \
  --format png
```

### CLI Options

- `--input` or `-i`: Path to input HTML file (required)
- `--output` or `-o`: Path to output image file (optional, derived from input if not provided)
- `--width` or `-w`: Viewport width in pixels (optional, default: 1920)
- `--height` or `-h`: Viewport height in pixels (optional, default: 1080; ignored if `--full-page` is set)
- `--full-page` or `-f`: Capture full scrollable page height (optional flag, default: false)
- `--format`: Image format (`png`, `jpeg`) (optional, detected from output filename extension; WebP deferred)
- `--quality` or `-q`: Image quality for JPEG (0-100) (optional, default: 90)
- `--help`: Display help information
- `--version`: Display version information

### Output Filename Derivation

When `--output` is not specified:
- Strip `.html` extension from input filename
- Append `.png` extension (default format)
- Place in same directory as input file

**Examples:**
- `comprehensive-demo.github.html` → `comprehensive-demo.github.png`
- `report.html` → `report.png`

### Image Format Detection

Format is determined in this priority order:
1. Explicit `--format` parameter (highest priority)
2. Output filename extension (`.png`, `.jpg`, `.jpeg`)
3. Default to PNG if neither specified

### Error Handling

**Invalid Input:**
- If input file doesn't exist: Display error message with file path, exit with code 1
- If input file is empty: Display error message, exit with code 1
- If input file is not valid HTML: Display error with details, exit with code 1

**Invalid Parameters:**
- If `--width` or `--height` is not a positive integer: Display error, exit with code 1
- If `--quality` is not between 0-100: Display error, exit with code 1
- If `--format` is not one of `png`, `jpeg`: Display error listing valid options, exit with code 1

**Output Issues:**
- If output directory doesn't exist: Create directory automatically
- If output file cannot be written: Display error with reason (permissions, disk space, etc.), exit with code 1

**Browser Issues:**
- If Chromium is not installed: Display message with installation instructions (`playwright install chromium`), exit with code 1
- If browser launch fails: Display error with details, exit with code 1
- If page load fails: Display error with details, exit with code 1

## Success Criteria

- [x] Standalone .NET 10 console application created in `tools/Oocx.TfPlan2Md.ScreenshotGenerator/`
- [x] Playwright for .NET integrated for Chromium automation
- [x] Unit test project created for the screenshot generator
- [x] CLI accepts all specified options and validates inputs correctly
- [x] Default viewport (1920x1080) screenshots generate correctly
- [x] Custom viewport dimensions work correctly via `--width` and `--height`
- [x] Full-page capture mode generates screenshots of entire scrollable content
- [x] PNG output format works correctly (default and explicit)
- [x] JPEG output format works correctly with quality settings
- [x] Image format detection from filename extension works correctly
- [x] Explicit `--format` parameter overrides filename extension
- [x] Output filename is correctly derived when `--output` is not specified
- [x] Quality parameter affects JPEG output appropriately
- [x] Tool works on local development machines (Windows, Linux, macOS)
- [x] Tool works in GitHub Actions pipelines with Playwright setup
- [x] Error messages are clear and actionable
- [x] Tool can process HTML files generated by feature 027's HTML renderer
- [x] Unit tests provide good coverage of screenshot generation logic and edge cases
- [x] Documentation updated to describe the new tool and typical workflows
- [x] README includes example combining HTML renderer (027) → screenshot generator (028) workflow

## Design Decisions

### Technology Selection

**Decision:** Use Playwright for .NET with bundled Chromium.

**Rationale:**
- **Zero external dependencies**: Chromium is bundled, eliminating version management issues
- **Built for automation**: Screenshot generation is a first-class feature, not an afterthought
- **Cross-platform**: Works on Windows, Linux, macOS without platform-specific code
- **GitHub Actions support**: Official `microsoft/playwright-github-action` simplifies CI/CD setup
- **Developer experience**: Works out of the box locally with minimal setup (`playwright install chromium`)
- **Active maintenance**: Supported by Microsoft, aligns with .NET ecosystem
- **Full-page screenshots**: Native support without custom scroll logic

**Alternatives considered:**
- **Puppeteer Sharp**: Less actively maintained, requires manual browser management
- **Selenium WebDriver**: Requires separate ChromeDriver installation, version compatibility issues, heavyweight

### Default Image Format

**Decision:** Use PNG as the default output format.

**Rationale:**
- Lossless compression preserves screenshot quality
- Widely supported across all platforms and tools
- No quality degradation for visual regression testing
- Standard format for documentation screenshots

Users can explicitly choose JPEG for smaller file sizes if needed. WebP is deferred for this release at the maintainer's request.

### Default Quality Settings

**Decision:** Use quality 90 for JPEG.

**Rationale:**
- High quality while providing reasonable file size reduction
- Standard "high quality" settings in image processing tools
- Balances visual fidelity with storage efficiency
- Users can override via `--quality` parameter if needed

### Viewport Defaults

**Decision:** Use 1920x1080 as default viewport size.

**Rationale:**
- Common desktop resolution (Full HD)
- Matches typical developer monitor resolution
- Wide enough to display reports without horizontal scrolling
- Standard for screenshot generation and visual testing

### Full-Page vs. Viewport Mode

**Decision:** Default to fixed viewport mode; require explicit `--full-page` flag for scrollable capture.

**Rationale:**
- Fixed viewport is more predictable for visual regression testing
- Full-page screenshots can be very tall and unwieldy for large reports
- Explicit flag makes user intent clear
- Both modes have valid use cases (viewport for testing, full-page for documentation)

### Chromium Installation

**Decision:** Do not bundle Chromium in the tool; rely on Playwright's installation mechanism.

**Rationale:**
- Playwright provides `playwright install chromium` command for one-time setup
- Keeps tool package size small
- Playwright handles browser updates and version management
- Standard Playwright workflow for all users
- Clear error messages guide users to install if missing

## Integration with Feature 027

The screenshot generator is designed to work seamlessly with the HTML renderer from feature 027:

**Typical Workflow:**
```bash
# Step 1: Convert markdown to HTML
dotnet run --project tools/Oocx.TfPlan2Md.HtmlRenderer -- \
  --input artifacts/comprehensive-demo.md \
  --flavor github \
  --template tools/Oocx.TfPlan2Md.HtmlRenderer/templates/github-wrapper.html \
  --output artifacts/comprehensive-demo.github.html

# Step 2: Generate screenshot from HTML
dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
  --input artifacts/comprehensive-demo.github.html \
  --output artifacts/comprehensive-demo.github.png \
  --full-page
```

**Shell Script Example:**
```bash
#!/bin/bash
# Generate GitHub-flavored HTML and screenshot
dotnet run --project tools/Oocx.TfPlan2Md.HtmlRenderer -- \
  -i "$1" -f github -t tools/Oocx.TfPlan2Md.HtmlRenderer/templates/github-wrapper.html -o "${1%.md}.github.html"

dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
  -i "${1%.md}.github.html" -o "${1%.md}.github.png" --full-page
```

## GitHub Actions Integration

### Playwright Setup

Playwright requires a one-time browser installation in CI/CD environments:

```yaml
- name: Setup Playwright
  run: dotnet tool install --global Microsoft.Playwright.CLI && playwright install chromium --with-deps
```

**Note:** The `--with-deps` flag installs system dependencies required by Chromium on Linux.

### Example Workflow

```yaml
name: Generate Report Screenshots
on: [push]
jobs:
  screenshots:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Setup Playwright
        run: |
          dotnet tool install --global Microsoft.Playwright.CLI
          playwright install chromium --with-deps
      
      - name: Build solution
        run: dotnet build
      
      - name: Generate HTML and Screenshots
        run: |
          # Generate HTML
          dotnet run --project tools/Oocx.TfPlan2Md.HtmlRenderer -- \
            -i artifacts/comprehensive-demo.md -f github \
            -t tools/Oocx.TfPlan2Md.HtmlRenderer/templates/github-wrapper.html
          
          # Generate screenshot
          dotnet run --project tools/Oocx.TfPlan2Md.ScreenshotGenerator -- \
            -i artifacts/comprehensive-demo.github.html --full-page
      
      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: artifacts/*.png
```

## Open Questions

None at this time. All requirements have been clarified.
