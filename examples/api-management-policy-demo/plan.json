{
  "format_version": "1.2",
  "terraform_version": "1.14.0",
  "timestamp": "2026-01-10T10:00:00Z",
  "resource_changes": [
    {
      "address": "azurerm_api_management_policy.global",
      "module_address": null,
      "mode": "managed",
      "type": "azurerm_api_management_policy",
      "name": "global",
      "provider_name": "registry.terraform.io/hashicorp/azurerm",
      "change": {
        "actions": ["update"],
        "before": {
          "id": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/rg-api-mgmt/providers/Microsoft.ApiManagement/service/apim-demo/policies/policy",
          "api_management_id": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/rg-api-mgmt/providers/Microsoft.ApiManagement/service/apim-demo",
          "xml_content": "<policies>\n  <inbound>\n    <!-- Rate limiting policy -->\n    <rate-limit calls=\"100\" renewal-period=\"60\" />\n    <!-- IP filtering -->\n    <ip-filter action=\"allow\">\n      <address>10.0.0.0/24</address>\n      <address>172.16.0.0/16</address>\n    </ip-filter>\n    <!-- CORS policy -->\n    <cors allow-credentials=\"true\">\n      <allowed-origins>\n        <origin>https://example.com</origin>\n        <origin>https://app.example.com</origin>\n      </allowed-origins>\n      <allowed-methods>\n        <method>GET</method>\n        <method>POST</method>\n        <method>PUT</method>\n        <method>DELETE</method>\n      </allowed-methods>\n      <allowed-headers>\n        <header>Content-Type</header>\n        <header>Authorization</header>\n        <header>X-Requested-With</header>\n      </allowed-headers>\n    </cors>\n    <!-- Authentication with Azure AD -->\n    <validate-jwt header-name=\"Authorization\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <openid-config url=\"https://login.microsoftonline.com/common/.well-known/openid-configuration\" />\n      <audiences>\n        <audience>api://12345678-1234-1234-1234-123456789abc</audience>\n      </audiences>\n      <required-claims>\n        <claim name=\"roles\" match=\"any\">\n          <value>Reader</value>\n          <value>Writer</value>\n        </claim>\n      </required-claims>\n    </validate-jwt>\n    <!-- Set backend service URL -->\n    <set-backend-service base-url=\"https://backend-old.example.com\" />\n    <!-- Add custom headers -->\n    <set-header name=\"X-Environment\" exists-action=\"override\">\n      <value>Production</value>\n    </set-header>\n    <set-header name=\"X-Request-Id\" exists-action=\"override\">\n      <value>@(Guid.NewGuid().ToString())</value>\n    </set-header>\n  </inbound>\n  <backend>\n    <base />\n  </backend>\n  <outbound>\n    <base />\n    <!-- Response caching -->\n    <cache-store duration=\"3600\" />\n    <!-- Remove internal headers -->\n    <set-header name=\"X-AspNet-Version\" exists-action=\"delete\" />\n    <set-header name=\"X-Powered-By\" exists-action=\"delete\" />\n  </outbound>\n  <on-error>\n    <base />\n    <!-- Log errors to Application Insights -->\n    <trace source=\"policy-error\" severity=\"error\">\n      <message>@(context.LastError.Message)</message>\n      <metadata name=\"request-id\" value=\"@(context.RequestId)\" />\n    </trace>\n  </on-error>\n</policies>",
          "xml_link": null
        },
        "after": {
          "id": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/rg-api-mgmt/providers/Microsoft.ApiManagement/service/apim-demo/policies/policy",
          "api_management_id": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/rg-api-mgmt/providers/Microsoft.ApiManagement/service/apim-demo",
          "xml_content": "<policies>\n  <inbound>\n    <!-- Rate limiting policy with increased limits -->\n    <rate-limit calls=\"200\" renewal-period=\"60\" />\n    <!-- IP filtering with additional networks -->\n    <ip-filter action=\"allow\">\n      <address>10.0.0.0/24</address>\n      <address>172.16.0.0/16</address>\n      <address>192.168.1.0/24</address>\n    </ip-filter>\n    <!-- CORS policy with additional origins -->\n    <cors allow-credentials=\"true\">\n      <allowed-origins>\n        <origin>https://example.com</origin>\n        <origin>https://app.example.com</origin>\n        <origin>https://portal.example.com</origin>\n      </allowed-origins>\n      <allowed-methods>\n        <method>GET</method>\n        <method>POST</method>\n        <method>PUT</method>\n        <method>DELETE</method>\n        <method>PATCH</method>\n      </allowed-methods>\n      <allowed-headers>\n        <header>Content-Type</header>\n        <header>Authorization</header>\n        <header>X-Requested-With</header>\n        <header>X-API-Key</header>\n      </allowed-headers>\n    </cors>\n    <!-- Authentication with Azure AD -->\n    <validate-jwt header-name=\"Authorization\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <openid-config url=\"https://login.microsoftonline.com/common/.well-known/openid-configuration\" />\n      <audiences>\n        <audience>api://12345678-1234-1234-1234-123456789abc</audience>\n      </audiences>\n      <required-claims>\n        <claim name=\"roles\" match=\"any\">\n          <value>Reader</value>\n          <value>Writer</value>\n          <value>Admin</value>\n        </claim>\n      </required-claims>\n    </validate-jwt>\n    <!-- Set backend service URL to new endpoint -->\n    <set-backend-service base-url=\"https://backend-new.example.com\" />\n    <!-- Add custom headers -->\n    <set-header name=\"X-Environment\" exists-action=\"override\">\n      <value>Production</value>\n    </set-header>\n    <set-header name=\"X-Request-Id\" exists-action=\"override\">\n      <value>@(Guid.NewGuid().ToString())</value>\n    </set-header>\n    <set-header name=\"X-API-Version\" exists-action=\"override\">\n      <value>2.0</value>\n    </set-header>\n    <!-- Request throttling per user -->\n    <quota-by-key calls=\"10000\" renewal-period=\"3600\" counter-key=\"@(context.Request.Headers.GetValueOrDefault(&quot;Authorization&quot;,&quot;&quot;))\" />\n  </inbound>\n  <backend>\n    <base />\n    <!-- Retry policy for backend failures -->\n    <retry condition=\"@(context.Response.StatusCode &gt;= 500)\" count=\"3\" interval=\"2\" first-fast-retry=\"true\" />\n  </backend>\n  <outbound>\n    <base />\n    <!-- Response caching with vary-by headers -->\n    <cache-store duration=\"3600\" vary-by-developer=\"false\" vary-by-developer-groups=\"false\">\n      <vary-by-header>Accept</vary-by-header>\n      <vary-by-header>Accept-Encoding</vary-by-header>\n    </cache-store>\n    <!-- Remove internal headers -->\n    <set-header name=\"X-AspNet-Version\" exists-action=\"delete\" />\n    <set-header name=\"X-Powered-By\" exists-action=\"delete\" />\n    <!-- Add security headers -->\n    <set-header name=\"X-Content-Type-Options\" exists-action=\"override\">\n      <value>nosniff</value>\n    </set-header>\n    <set-header name=\"X-Frame-Options\" exists-action=\"override\">\n      <value>DENY</value>\n    </set-header>\n  </outbound>\n  <on-error>\n    <base />\n    <!-- Log errors to Application Insights with additional context -->\n    <trace source=\"policy-error\" severity=\"error\">\n      <message>@(context.LastError.Message)</message>\n      <metadata name=\"request-id\" value=\"@(context.RequestId)\" />\n      <metadata name=\"operation-name\" value=\"@(context.Operation.Name)\" />\n      <metadata name=\"status-code\" value=\"@(context.Response.StatusCode.ToString())\" />\n    </trace>\n    <!-- Send error notification -->\n    <send-one-way-request mode=\"new\">\n      <set-url>https://monitoring.example.com/api/alerts</set-url>\n      <set-method>POST</set-method>\n      <set-header name=\"Content-Type\" exists-action=\"override\">\n        <value>application/json</value>\n      </set-header>\n      <set-body>@{\n        return new JObject(\n          new JProperty(&quot;error&quot;, context.LastError.Message),\n          new JProperty(&quot;requestId&quot;, context.RequestId),\n          new JProperty(&quot;timestamp&quot;, DateTime.UtcNow.ToString())\n        ).ToString();\n      }</set-body>\n    </send-one-way-request>\n  </on-error>\n</policies>",
          "xml_link": null
        },
        "after_unknown": {},
        "before_sensitive": {},
        "after_sensitive": {}
      }
    }
  ]
}
