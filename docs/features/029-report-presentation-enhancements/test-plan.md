# Test Plan: Report Presentation Enhancements

## Overview

This test plan covers the visual and functional enhancements for report presentation, including resource border styling, report metadata display, screenshot tool partial capture, and semantic name icons.

Reference: [specification.md](specification.md)

## Test Coverage Matrix

| Acceptance Criterion | Test Case(s) | Test Type |
|---------------------|--------------|-----------|
| All resource types are wrapped in `<details>` blocks with inline border styles in markdown | TC-01, TC-02 | Unit (Snapshot) |
| Azure DevOps HTML output shows #f0f0f0 borders on all resources | TC-03 | Integration (HTML Renderer) |
| HtmlRendererApp GitHub flavor strips inline styles from details blocks | TC-04 | Integration (HTML Renderer) |
| Resources previously without details blocks use `<details open>` and remain expanded | TC-02 | Unit (Snapshot) |
| Screenshot tool accepts `--target-terraform-resource-id` argument | TC-05 | Unit (CLI Parser) |
| Screenshot tool accepts `--target-selector` argument | TC-06 | Unit (CLI Parser) |
| Partial screenshots capture only the specified element(s) | TC-07, TC-08 | Integration (Screenshot Tool) |
| Screenshot tool errors gracefully when target not found | TC-09 | Integration (Screenshot Tool) |
| Report header displays tfplan2md version, commit hash, and generation date | TC-10 | Unit (Snapshot) |
| Terraform version and metadata appear on same line in header | TC-10 | Unit (Snapshot) |
| `--hide-metadata` flag suppresses the entire version/date line | TC-11 | Unit (Snapshot) |
| Snapshot tests pass with stable version/date handling | TC-12 | Unit (Snapshot) |
| `resource_group_name` attributes display with üìÅ icon | TC-13 | Unit (Snapshot) |
| Generic `name` attributes (all providers) display with üÜî icon | TC-14 | Unit (Snapshot) |
| Name icons follow existing semantic formatting patterns | TC-13, TC-14 | Unit (Snapshot) |

## User Acceptance Scenarios

> **Purpose**: For user-facing features (especially rendering changes), define scenarios for manual Maintainer review via Test PRs in GitHub and Azure DevOps. These help catch rendering bugs and validate real-world usage before merge.

### Scenario 1: Visual Hierarchy and Metadata in Azure DevOps

**User Goal**: Verify that the report has a clear visual hierarchy with borders and includes metadata when viewed in Azure DevOps.

**Test PR Context**:
- **Azure DevOps**: Verify rendering in Azure DevOps PR description.

**Expected Output**:
- Each resource block is enclosed in a light gray border (#f0f0f0) with padding.
- Resources like Firewall rules and NSGs are expanded by default but still have the border.
- The header contains a line like: `Generated by tfplan2md 1.2.3 (abc1234) on 2026-01-03 14:23:15 UTC | Terraform 1.6.0`.
- `name` attributes have the üÜî icon.
- `resource_group_name` attributes have the üìÅ icon.

**Success Criteria**:
- [ ] Output renders correctly in Azure DevOps Markdown.
- [ ] Borders are visible and consistent.
- [ ] Metadata is present and correctly formatted.
- [ ] Icons are visible and correctly placed.

---

### Scenario 2: GitHub Rendering and Metadata Suppression

**User Goal**: Verify that the report renders correctly in GitHub (without borders) and that metadata can be hidden.

**Test PR Context**:
- **GitHub**: Verify rendering in GitHub PR comments/description.

**Expected Output**:
- Resource blocks do NOT have visible borders (GitHub strips them).
- The metadata line is completely absent when `--hide-metadata` is used.
- Semantic structure (details blocks) is preserved.

**Success Criteria**:
- [ ] Output renders correctly in GitHub Markdown.
- [ ] No broken styles or layout issues in GitHub.
- [ ] Metadata line is hidden when requested.

---

### Scenario 3: Partial Screenshot Capture

**User Goal**: Generate a screenshot of a specific resource for documentation.

**Test PR Context**:
- **Artifact**: A PNG file generated using the screenshot tool with `--target-terraform-resource-id`.

**Expected Output**:
- The PNG file contains only the specified resource block, not the entire report.
- The capture is clean and includes the resource summary and its details.

**Success Criteria**:
- [ ] Screenshot tool successfully captures only the target element.
- [ ] Output image is correctly sized to the element's bounding box.

## Test Cases

### TC-01: Resource_DefaultTemplate_IncludesBorderStyle

**Type:** Unit (Snapshot)

**Description:**
Verifies that the default resource template wraps the resource in a `<details>` block with the specified inline styles.

**Preconditions:**
- A standard Terraform plan with a simple resource (e.g., `azurerm_storage_account`).

**Test Steps:**
1. Run `tfplan2md` on the plan.
2. Inspect the generated Markdown.

**Expected Result:**
The resource is wrapped in `<details style="margin-bottom:12px; border:1px solid #f0f0f0; padding:12px;">`.

**Test Data:**
`tests/Oocx.TfPlan2Md.Tests/TestData/azurerm_storage_account.json`

---

### TC-02: Resource_FirewallTemplate_IncludesOpenBorderStyle

**Type:** Unit (Snapshot)

**Description:**
Verifies that resources that don't normally use details blocks (like Firewall rules) are now wrapped in `<details open>` with the border style.

**Preconditions:**
- A Terraform plan with an `azurerm_firewall` resource.

**Test Steps:**
1. Run `tfplan2md` on the plan.
2. Inspect the generated Markdown.

**Expected Result:**
The firewall resource is wrapped in `<details open style="margin-bottom:12px; border:1px solid #f0f0f0; padding:12px;">`.

**Test Data:**
`tests/Oocx.TfPlan2Md.Tests/TestData/azurerm_firewall.json`

---

### TC-03: HtmlRenderer_AzureDevOps_PreservesBorders

**Type:** Integration (HTML Renderer)

**Description:**
Verifies that the Azure DevOps flavor of the HTML renderer preserves the inline border styles.

**Preconditions:**
- Markdown input containing `<details style="border:1px solid #f0f0f0;">`.

**Test Steps:**
1. Run `HtmlRendererApp` with `--platform azdo`.
2. Inspect the generated HTML.

**Expected Result:**
The `style` attribute is preserved (possibly normalized, but the border remains).

---

### TC-04: HtmlRenderer_GitHub_StripsBorders

**Type:** Integration (HTML Renderer)

**Description:**
Verifies that the GitHub flavor of the HTML renderer strips the inline border styles.

**Preconditions:**
- Markdown input containing `<details style="border:1px solid #f0f0f0;">`.

**Test Steps:**
1. Run `HtmlRendererApp` with `--platform github`.
2. Inspect the generated HTML.

**Expected Result:**
The `style` attribute is removed from the `<details>` tag.

---

### TC-05: ScreenshotTool_CliParser_ParsesTargetResourceId

**Type:** Unit (CLI Parser)

**Description:**
Verifies that the screenshot tool correctly parses the `--target-terraform-resource-id` argument.

**Test Steps:**
1. Run `CliParser.Parse` with `--target-terraform-resource-id "azurerm_firewall.example"`.

**Expected Result:**
The resulting options object has the `TargetTerraformResourceId` property set to `"azurerm_firewall.example"`.

---

### TC-06: ScreenshotTool_CliParser_ParsesTargetSelector

**Type:** Unit (CLI Parser)

**Description:**
Verifies that the screenshot tool correctly parses the `--target-selector` argument.

**Test Steps:**
1. Run `CliParser.Parse` with `--target-selector "details:has(summary:has-text('my-resource'))"`.

**Expected Result:**
The resulting options object has the `TargetSelector` property set to the provided string.

---

### TC-07: ScreenshotTool_Capture_PartialByResourceId

**Type:** Integration (Screenshot Tool)

**Description:**
Verifies that the screenshot tool can capture a specific resource by its Terraform address.

**Preconditions:**
- An HTML report containing multiple resources.

**Test Steps:**
1. Run the screenshot tool with `--target-terraform-resource-id "azurerm_storage_account.sa"`.
2. Verify the output image dimensions.

**Expected Result:**
The output image dimensions match the bounding box of the targeted resource, not the full page.

---

### TC-08: ScreenshotTool_Capture_PartialBySelector

**Type:** Integration (Screenshot Tool)

**Description:**
Verifies that the screenshot tool can capture an element by a Playwright selector.

**Preconditions:**
- An HTML report.

**Test Steps:**
1. Run the screenshot tool with `--target-selector "h1"`.
2. Verify the output image.

**Expected Result:**
The output image contains only the `h1` element.

---

### TC-09: ScreenshotTool_Capture_FailsWhenTargetNotFound

**Type:** Integration (Screenshot Tool)

**Description:**
Verifies that the screenshot tool exits with a non-zero code and a clear error message when the target is not found.

**Test Steps:**
1. Run the screenshot tool with `--target-selector "#non-existent"`.

**Expected Result:**
The tool exits with a non-zero code and prints an error message indicating the target was not found.

---

### TC-10: Report_Metadata_DisplaysCorrectly

**Type:** Unit (Snapshot)

**Description:**
Verifies that the report header includes the version, commit, and timestamp.

**Preconditions:**
- Mocked metadata provider returning fixed values: Version `1.2.3`, Commit `abc1234`, Date `2026-01-03 14:23:15 UTC`.

**Test Steps:**
1. Run `tfplan2md`.
2. Inspect the header.

**Expected Result:**
Header contains: `Generated by tfplan2md 1.2.3 (abc1234) on 2026-01-03 14:23:15 UTC | Terraform 1.6.0`.

---

### TC-11: Report_Metadata_HiddenWhenRequested

**Type:** Unit (Snapshot)

**Description:**
Verifies that `--hide-metadata` suppresses the metadata line.

**Test Steps:**
1. Run `tfplan2md --hide-metadata`.
2. Inspect the header.

**Expected Result:**
The metadata line is absent.

---

### TC-12: SnapshotTests_StableWithMetadata

**Type:** Unit (Snapshot)

**Description:**
Ensures that existing snapshot tests remain stable by using deterministic metadata.

**Test Steps:**
1. Run existing snapshot tests.

**Expected Result:**
Tests pass without needing manual snapshot updates for every run (due to timestamp changes).

---

### TC-13: Attribute_ResourceGroupName_ShowsFolderIcon

**Type:** Unit (Snapshot)

**Description:**
Verifies that `resource_group_name` attributes are rendered with the üìÅ icon.

**Expected Result:**
Value is rendered as `üìÅ my-rg` (with non-breaking space).

---

### TC-14: Attribute_Name_ShowsIdIcon

**Type:** Unit (Snapshot)

**Description:**
Verifies that `name` attributes are rendered with the üÜî icon.

**Expected Result:**
Value is rendered as `üÜî my-name` (with non-breaking space).

## Test Data Requirements

- `tests/Oocx.TfPlan2Md.Tests/TestData/metadata_test.json` - A simple plan to test metadata display.
- `tests/Oocx.TfPlan2Md.Tests/TestData/icons_test.json` - A plan with various `name` and `resource_group_name` attributes.

## Edge Cases

| Scenario | Expected Behavior | Test Case |
|----------|-------------------|-----------|
| Target resource ID not found | Error message and non-zero exit | TC-09 |
| Selector matches multiple elements | Capture union bounding box | TC-08 (variant) |
| Commit hash unavailable | Display "unknown" or omit | TC-10 (variant) |
| Resource without `name` attribute | No icon displayed | TC-14 (variant) |
| Nested `<details>` blocks | Only outer block gets border | TC-01 (variant) |

## Non-Functional Tests

- **Performance**: Screenshot capture of a single element should be faster or equal to full-page capture.
- **Error Handling**: Clear error messages for invalid selectors or missing targets in the screenshot tool.

## Open Questions

None.
