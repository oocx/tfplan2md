# Test Plan: AOT-Compiled Trimmed Docker Image

## Overview

Verify that replacing the standard .NET runtime build with an AOT-compiled, trimmed version preserves all functionality while achieving the targeted size and security improvements.

## Test Coverage Matrix

| Acceptance Criterion | Test Case(s) | Test Type |
|---------------------|--------------|-----------|
| All existing unit tests pass | CI Run (dotnet test) | Unit |
| All existing integration tests pass | TC-01 (Docker Integration Tests) | Integration |
| All features from `docs/features.md` work | TC-01, TC-02, TC-03 | Integration / E2E |
| Docker image size reduced | TC-04 (Metrics Capture) | Metric |
| Build time impact documented | TC-05 (Metrics Capture) | Metric |
| Base image is minimal (chiseled) | TC-06 (Base Image Verification) | Metric |
| No reflection errors in AOT | TC-01, TC-02, TC-03 | Integration |
| Metadata (version/commit) works | TC-02 (Metadata Verification) | Integration |

## User Acceptance Scenarios

### Scenario 1: Comprehensive Demo Rendering Verification

**User Goal**: Ensure the AOT-compiled version produces the exact same high-quality report for a complex plan.

**Test PR Context**:
- **GitHub**: Post comment from artifacts generated by the AOT-built image.
- **Azure DevOps**: Post comment from artifacts generated by the AOT-built image.

**Expected Output**:
- The report is identical to the baseline snapshots (modulo timestamps).
- All sections (Summary, Resource Changes, Tables) render correctly.
- Footer contains correct version and commit hash.

**Success Criteria**:
- [ ] Output renders correctly in GitHub Markdown
- [ ] Output renders correctly in Azure DevOps Markdown
- [ ] No Scriban/Reflection errors in logs or output
- [ ] Assembly metadata (version/commit) is correctly extracted and displayed

### Scenario 2: Custom Template Loading

**User Goal**: Verify that the AOT version can still load and use custom templates from the filesystem (exercises filesystem access and dynamic template parsing).

**Test PR Context**:
- Run `tfplan2md` with `--template` pointing to a custom `.sbn` file (e.g., `examples/firewall-rules-demo/custom-template.sbn`).

**Expected Output**:
- Report is rendered using the custom template logic.

**Success Criteria**:
- [ ] Custom template is successfully loaded and applied.
- [ ] No "file not found" or "access denied" errors when running as non-root in the chiseled container.

---

## Test Cases

### TC-01: Full Integration Suite in AOT Container

**Type:** Integration

**Description:**
Run the existing suite of Docker-based integration tests against the newly built AOT image to ensure CLI behavior remains identical.

**Preconditions:**
- NativeAOT Docker image is built and tagged locally.

**Test Steps:**
1. Execute `scripts/test-with-timeout.sh -- dotnet test --solution src/tfplan2md.slnx --filter Category=Docker`.
2. Monitor output for any AOT/Trimming specific warnings or errors.

**Expected Result:**
All tests pass, confirming basic CLI functionality (stdin, file input, help, version) works in the AOT environment.

---

### TC-02: Metadata and Version Verification

**Type:** Integration

**Description:**
Verify that the AOT-compiled executable can still read its own assembly attributes, which is a known risk area in trimming.

**Preconditions:**
- Image built with proper `AssemblyMetadata` and `Version` set during `dotnet publish`.

**Test Steps:**
1. Run `docker run tfplan2md --version`.
2. Inspect the generated report footer for the string "Generated by tfplan2md v... (commit ...)".

**Expected Result:**
Version and commit hash are non-empty and reflect the build-time values, not "unknown" or empty strings.

---

### TC-03: Reflection-Heavy Feature Check (Scriban rendering)

**Type:** Integration

**Description:**
Comprehensive run against all plans in `src/tests/Oocx.TfPlan2Md.Tests/TestData/` to ensure all Scriban templates and helpers work without reflection-related failures.

**Preconditions:**
- AOT Docker image built.

**Test Steps:**
1. Run `tfplan2md` for every `.json` file in the TestData directory.
2. Verify that none of the runs result in a crash or "Missing member" error in the output.

**Expected Result:**
No `MissingMethodException`, `TypeLoadException`, or Scriban rendering errors. This confirms that trimming did not remove necessary POCO members used by templates.

---

### TC-04: Image Size Metric

**Type:** Metric

**Description:**
Quantify the image size reduction achieved by switching to NativeAOT and `runtime-deps:chiseled`.

**Test Steps:**
1. Record size of previous `runtime:noble-chiseled` based image.
2. Record size of new AOT-based image.
3. Calculate percentage reduction.

**Expected Result:**
Docker image size is measurably reduced (targeted < 50MB from ~200MB).

---

### TC-05: Build Time Metric

**Type:** Metric

**Description:**
Measure the impact on CI build duration, as AOT compilation is significantly slower.

**Test Steps:**
1. Capture duration of `docker build` for the AOT image in CI.
2. Compare with baseline build times.

**Expected Result:**
Build time increase is documented.

---

### TC-06: Base Image and Security Verification

**Type:** Metric / Integration

**Description:**
Verify the final image uses the minimal `runtime-deps` base and contains no unnecessary binaries.

**Test Steps:**
1. Run `docker inspect <image>` to verify the base image.
2. Attempt to run `sh` or `ls` in the container.

**Expected Result:**
- Base image is `mcr.microsoft.com/dotnet/runtime-deps:10.0-noble-chiseled`.
- Container fails to run `sh` (confirming minimal footprint).

---

## Test Data Requirements

No new test data files are required. The existing suite in `src/tests/Oocx.TfPlan2Md.Tests/TestData/` is sufficient:
- `azurerm-azuredevops-plan.json` (Comprehensive)
- `firewall-rule-changes.json` (Custom helpers/templates)
- `multi-module-plan.json` (Complex hierarchy)

## Edge Cases

| Scenario | Expected Behavior | Test Case |
|----------|-------------------|-----------|
| Large plan (>1000 resources) | Handled by Scriban iteration limit without crashing | TC-03 |
| Invalid JSON input | Exit code 1 with descriptive error | TC-01 |
| Non-ASCII characters in plan | Rendered correctly (verifies Globalization) | TC-03 |

## Non-Functional Tests

- **Startup Latency**: Compare time-to-output for `--help` between baseline and AOT.
- **Memory Footprint**: Monitor peak memory usage during a large plan processing to ensure no leaks or excessive allocations in AOT.

## Open Questions

- **AOT compilation for other architectures**: Does the current CI support building NativeAOT for `arm64` if needed later? (Currently restricted to `x64` per architecture doc).
